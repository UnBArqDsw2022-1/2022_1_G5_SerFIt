<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="app">
        <div class="content"></div>
    </div>
</body>

</html>

<style>
    #app {
        margin: 0;
        padding: 0;
    }
    
    .content {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: space-between;
    }
    
    .card {
        display: flex;
        flex-direction: column;
    }
    
    .card .card-title {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    
    .card .card-tag {
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
    }
    
    .card .card-img {
        border-radius: 50%;
        flex-basis: 200px;
        max-width: 200px;
    }
</style>

<script>
    const issue1 = 'https://api.github.com/repos/UnBArqDsw2022-1/2022_1_grupo5/issues/1';

    function getMembers(url) {
        return new Promise((resolve, reject) => {
            var memReq = new XMLHttpRequest();

            memReq.onload = () => {
                if (memReq.readyState == XMLHttpRequest.DONE && memReq.status == 200) {
                    resolve(JSON.parse(memReq.responseText).assignees);
                }
            };

            memReq.onerror = () => {
                reject(memReq.statusText)
            };

            memReq.open('GET', url, true);
            memReq.send();
        });
    }

    async function createMembersCards(issue = issue1) {
        getMembers(issue)
            .then(members => {
                let cardDiv = document.querySelector('.content');
                members.forEach(async(member) => {
                    let cardImg = buildImgCard(member.avatar_url);
                    let followers = await buildFollowTag(member.followers_url);
                    let cardTitle = await buildTitle(member.login, member.url);
                    /*let usrLink = getUsrLink(member);
                     */
                    let card = appendCardChildren([cardImg, followers, cardTitle /*, usrLink */ ]);

                    cardDiv.appendChild(card);
                });
            })
            .catch(error => console.log('Error:', error));
    }

    function buildTitle(login, userUrl) {
        return new Promise(resolve => {
            getUserName(userUrl).then(name => {
                let cardName = document.createElement('div');

                let nameElem = document.createElement('p');
                nameElem.innerText = name;

                let loginElem = document.createElement('span');
                loginElem.innerText = login;

                cardName.className = 'card-title';
                cardName.appendChild(nameElem);
                cardName.appendChild(loginElem);

                resolve(cardName);
            });
        });
    }

    function buildFollowTag(followersUrl) {
        return new Promise(resolve => {
            getNumFollowers(followersUrl).then(num => {
                let followTag = document.createElement('div');
                followTag.className = 'card-tag';

                let p = document.createElement('p');
                p.innerText = `${num}`;

                let span = document.createElement('span');
                span.innerText = 'followers'
                followTag.appendChild(span);
                followTag.appendChild(p);


                resolve(followTag);
            });
        });
    }

    function buildImgCard(avatarUrl) {
        let avatar = document.createElement('img');
        avatar.className = 'card-img';
        avatar.setAttribute('src', avatarUrl);

        return avatar;
    }



    async function getNumFollowers(followersUrl) {
        console.log('Entered Get');
        return new Promise(resolve => {
            let request = new XMLHttpRequest();
            request.open('GET', followersUrl, true);

            request.onload = () => {
                if (request.status >= 200 && request.status < 300) {
                    let followers = Array.from(JSON.parse(request.responseText)).reduce((prev) => ++prev, 0);
                    resolve(followers);
                }
            }

            request.send();
        });
    }

    async function getUserName(userUrl) {
        console.log('Entered Get');
        return new Promise(resolve => {
            let request = new XMLHttpRequest();
            request.open('GET', userUrl, true);

            request.onload = () => {
                if (request.status >= 200 && request.status < 300) {
                    let name = JSON.parse(request.responseText).name;
                    resolve(name);
                }
            }

            request.send();
        });
    }

    function appendCardChildren([cardImg, followers, cardTitle /*, usrLink */ ]) {
        let card = document.createElement('div');
        card.className = 'card';

        card.appendChild(cardImg);
        card.appendChild(cardTitle);
        card.append(followers);

        return card;
    }

    document.addEventListener('DOMContentLoaded', async function() {
        await createMembersCards(issue1);
    })
</script>